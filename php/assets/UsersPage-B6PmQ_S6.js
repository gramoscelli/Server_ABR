import{c as M,r as c,i as he,b as pe,k as u,j as e,B as m,e as xe,g as ue,h as je,l as ve,f as fe,R as ge}from"./index-CQK1xMEp.js";import{A as ye,K as we}from"./AdminLayout-536hJOLm.js";import{P as Ce,S as Ee,d as be,e as Ne,f as ke,g as Se,h as Te,D,a as F,b as L,c as O,i as $,j as A}from"./switch-Dz3YD5rp.js";import{I as j}from"./input-CE_qf2K-.js";import{L as v}from"./label-BnvKK__y.js";import{P as Re}from"./PasswordStrengthIndicator-zkYWuGO2.js";import{S as Pe}from"./search-DViEtzHB.js";import{M as U}from"./mail-DCwd_jzR.js";import"./lock-D4HCCPhn.js";import"./log-out-CvvekA6y.js";import"./circle-x-BFxV6b72.js";import"./circle-check-CC1GL2rZ.js";/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const De=[["path",{d:"M22 13V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12c0 1.1.9 2 2 2h8",key:"12jkf8"}],["path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7",key:"1ocrg3"}],["path",{d:"m16 19 2 2 4-4",key:"1b14m6"}]],Fe=M("mail-check",De);/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Le=[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]],Oe=M("square-pen",Le);/**
 * @license lucide-react v0.553.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $e=[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],Ae=M("trash-2",$e);function Ge(){const[V,q]=c.useState([]),[X,H]=c.useState([]),[B,J]=c.useState(!0),[g,K]=c.useState(""),[G,y]=c.useState(!1),[h,_]=c.useState(!1),[s,E]=c.useState(null),[l,f]=c.useState({username:"",email:"",nombre:"",apellido:"",password:""}),[z,W]=c.useState(null),[Q,b]=c.useState(!1),[Y,N]=c.useState(!1),[k,S]=c.useState(""),[w,T]=c.useState(""),{toast:t}=he(),R=pe.getUser(),P=(R==null?void 0:R.role)==="root",C=a=>({root:"Administrador",admin_employee:"Empleado de Administración",library_employee:"Empleado de Biblioteca",new_user:"Usuario Nuevo",readonly:"Solo Lectura"})[a]||a;c.useEffect(()=>{p(),ce()},[]);const p=async()=>{try{console.log("[UsersPage] Fetching users...");const a=await u("/api/admin/users");if(console.log("[UsersPage] Response received:",a.status),a.ok){const r=await a.json();console.log("[UsersPage] Users data:",r),q(r)}else{const r=await a.json().catch(()=>({}));console.error("[UsersPage] Error response:",r),t({variant:"destructive",title:"Error",description:r.message||"Error al cargar usuarios"})}}catch(a){console.error("[UsersPage] Exception:",a),t({variant:"destructive",title:"Error",description:"Error de red al cargar usuarios"})}finally{J(!1)}},Z=()=>{_(!1),E(null),f({username:"",email:"",nombre:"",apellido:"",password:""}),y(!0)},ee=a=>{_(!0),E(a),f({username:a.username,email:a.email,nombre:a.nombre||"",apellido:a.apellido||"",password:""}),y(!0)},ae=async a=>{if(a.preventDefault(),l.password&&(!z||!z.valid)){t({variant:"destructive",title:"Error",description:"La contraseña no cumple con los requisitos de seguridad"});return}try{const r=await fetch("/api/csrf-token",{credentials:"include"}),{csrfToken:i}=await r.json(),o=h?`/api/admin/users/${s==null?void 0:s.id}`:"/api/admin/users",n=await u(o,{method:h?"PUT":"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":i},body:JSON.stringify(l)});if(n.ok)t({variant:"success",title:"Éxito",description:`Usuario ${h?"actualizado":"creado"} exitosamente`}),y(!1),p();else{const x=await n.json();t({variant:"destructive",title:"Error",description:x.message||"Operación fallida"})}}catch{t({variant:"destructive",title:"Error",description:"Error de red"})}},se=async(a,r)=>{if(r==="admin"){t({variant:"destructive",title:"No se puede eliminar admin",description:'La cuenta "admin" está protegida y no se puede eliminar'});return}if(confirm("¿Estás seguro de que quieres eliminar este usuario?"))try{const i=await fetch("/api/csrf-token",{credentials:"include"}),{csrfToken:o}=await i.json(),d=await u(`/api/admin/users/${a}`,{method:"DELETE",headers:{"X-CSRF-Token":o}});if(d.ok)t({variant:"success",title:"Éxito",description:"Usuario eliminado exitosamente"}),p();else{const n=await d.json().catch(()=>({}));t({variant:"destructive",title:"Error",description:n.message||"Error al eliminar usuario"})}}catch{t({variant:"destructive",title:"Error",description:"Error de red"})}},te=a=>{E(a),S(""),b(!0)},re=async()=>{if(!(!s||!k))try{const a=await fetch("/api/csrf-token",{credentials:"include"}),{csrfToken:r}=await a.json(),i=await u(`/api/admin/users/${s.id}/reset-password`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":r},body:JSON.stringify({temporaryPassword:k})});if(i.ok){const o=await i.json();t({title:"Contraseña restablecida",description:o.warning||"Contraseña temporal establecida exitosamente"}),b(!1),S("")}else{const o=await i.json();t({variant:"destructive",title:"Error",description:o.message||"Error al restablecer contraseña"})}}catch{t({variant:"destructive",title:"Error",description:"Error de red"})}},ie=async(a,r)=>{if(confirm(`¿Marcar el email de ${r} como verificado?`))try{const i=await fetch("/api/csrf-token",{credentials:"include"}),{csrfToken:o}=await i.json(),d=await u(`/api/admin/users/${a}/verify-email`,{method:"POST",headers:{"X-CSRF-Token":o}});if(d.ok)t({title:"Email verificado",description:"El email ha sido marcado como verificado"}),p();else{const n=await d.json();t({variant:"destructive",title:"Error",description:n.message||"Error al verificar email"})}}catch{t({variant:"destructive",title:"Error",description:"Error de red"})}},oe=async(a,r)=>{if(confirm(`¿Reenviar email de verificación a ${r}?`))try{const i=await fetch("/api/csrf-token",{credentials:"include"}),{csrfToken:o}=await i.json(),d=await u(`/api/admin/users/${a}/resend-verification`,{method:"POST",headers:{"X-CSRF-Token":o}});if(d.ok)t({title:"Email enviado",description:"Email de verificación reenviado exitosamente"});else{const n=await d.json();t({variant:"destructive",title:"Error",description:n.message||"Error al reenviar email"})}}catch{t({variant:"destructive",title:"Error",description:"Error de red"})}},ne=a=>{E(a),T(a.email),N(!0)},le=async()=>{if(!(!s||!w))try{const a=await fetch("/api/csrf-token",{credentials:"include"}),{csrfToken:r}=await a.json(),i=await u(`/api/admin/users/${s.id}/change-email`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":r},body:JSON.stringify({newEmail:w})});if(i.ok){const o=await i.json();t({title:"Email cambiado",description:o.warning||"Email actualizado exitosamente"}),N(!1),T(""),p()}else{const o=await i.json();t({variant:"destructive",title:"Error",description:o.message||"Error al cambiar email"})}}catch{t({variant:"destructive",title:"Error",description:"Error de red"})}},ce=async()=>{try{const a=await u("/api/roles");if(a.ok){const r=await a.json();H(r.roles||[])}}catch(a){console.error("[UsersPage] Error fetching roles:",a)}},de=async(a,r,i)=>{try{const o=await fetch("/api/csrf-token",{credentials:"include"}),{csrfToken:d}=await o.json(),n=await u(`/api/roles/user/${a}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-Token":d},body:JSON.stringify({role_id:parseInt(i)})});if(n.ok){const x=await n.json();t({title:"Rol actualizado",description:`Rol de ${r} cambiado de ${C(x.user.old_role)} a ${C(x.user.new_role)}`}),p()}else{const x=await n.json();t({variant:"destructive",title:"Error",description:x.message||"Error al cambiar rol"}),p()}}catch{t({variant:"destructive",title:"Error",description:"Error de red"}),p()}},me=async(a,r,i)=>{try{const o=await fetch("/api/csrf-token",{credentials:"include"}),{csrfToken:d}=await o.json(),n=await u(`/api/admin/users/${a}/toggle-active`,{method:"PATCH",headers:{"X-CSRF-Token":d}});if(n.ok){const x=await n.json();t({title:x.message,description:`Cuenta de ${r} ${i?"desactivada":"activada"}`}),p()}else{const x=await n.json();t({variant:"destructive",title:"Error",description:x.message||"Error al cambiar estado"}),p()}}catch{t({variant:"destructive",title:"Error",description:"Error de red"}),p()}},I=V.filter(a=>a.username.toLowerCase().includes(g.toLowerCase())||a.email.toLowerCase().includes(g.toLowerCase())||a.nombre&&a.nombre.toLowerCase().includes(g.toLowerCase())||a.apellido&&a.apellido.toLowerCase().includes(g.toLowerCase()));return e.jsx(ye,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Usuarios"}),e.jsx("p",{className:"mt-2 text-gray-600",children:"Gestionar usuarios del sistema y permisos"})]}),P&&e.jsxs(m,{onClick:Z,children:[e.jsx(Ce,{className:"mr-2 h-4 w-4"}),"Agregar Usuario"]})]}),e.jsxs(xe,{children:[e.jsxs(ue,{children:[e.jsx(je,{children:"Lista de Usuarios"}),e.jsx(ve,{children:"Todos los usuarios registrados en el sistema"})]}),e.jsxs(fe,{children:[e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx(Pe,{className:"absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400"}),e.jsx(j,{placeholder:"Buscar usuarios...",className:"pl-10",value:g,onChange:a=>K(a.target.value)})]})}),B?e.jsx("div",{className:"text-center py-8",children:"Cargando..."}):e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b",children:[e.jsx("th",{className:"text-left py-3 px-4 font-medium text-sm",children:"Nombre de usuario"}),e.jsx("th",{className:"text-center py-3 px-4 font-medium text-sm",children:"Email"}),e.jsx("th",{className:"text-left py-3 px-4 font-medium text-sm",children:"Rol"}),e.jsx("th",{className:"text-center py-3 px-4 font-medium text-sm",children:"Estado"}),e.jsx("th",{className:"text-left py-3 px-4 font-medium text-sm",children:"Creado"}),e.jsx("th",{className:"text-right py-3 px-4 font-medium text-sm",children:"Acciones"})]})}),e.jsx("tbody",{children:I.map(a=>{var r;return e.jsxs("tr",{className:"border-b hover:bg-gray-50",children:[e.jsx("td",{className:"py-3 px-4 text-sm font-medium",children:a.username}),e.jsx("td",{className:"py-3 px-4 text-sm",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx("a",{href:`mailto:${a.email}`,title:a.email,className:"inline-flex items-center justify-center h-8 w-8 rounded-lg hover:bg-blue-50 transition-colors",children:e.jsx(U,{className:"h-4 w-4 text-blue-600"})}),a.username!=="admin"&&e.jsxs(e.Fragment,{children:[e.jsx(m,{variant:"ghost",size:"icon",onClick:()=>ne(a),title:"Cambiar email",className:"h-8 w-8",children:e.jsx(ge,{className:"h-4 w-4 text-purple-600"})}),!a.email_verified&&e.jsxs(e.Fragment,{children:[e.jsx(m,{variant:"ghost",size:"icon",onClick:()=>ie(a.id,a.username),title:"Marcar email como verificado",className:"h-8 w-8",children:e.jsx(Fe,{className:"h-4 w-4 text-green-600"})}),e.jsx(m,{variant:"ghost",size:"icon",onClick:()=>oe(a.id,a.email),title:"Reenviar email de verificación",className:"h-8 w-8",children:e.jsx(U,{className:"h-4 w-4 text-orange-600"})})]})]})]})}),e.jsx("td",{className:"py-3 px-4 text-sm",children:a.username==="admin"||!P?e.jsx("span",{className:"inline-block px-3 py-2 text-sm text-gray-700 bg-gray-100 rounded-md",children:a.role?C(a.role):"Sin rol"}):e.jsxs(Ee,{value:((r=a.role_id)==null?void 0:r.toString())||"",onValueChange:i=>de(a.id,a.username,i),children:[e.jsx(be,{className:"w-full max-w-[200px] text-left",children:e.jsx(Ne,{placeholder:"Seleccionar rol",children:a.role?C(a.role):"Sin rol"})}),e.jsx(ke,{children:X.map(i=>e.jsx(Se,{value:i.id.toString(),children:C(i.name)},i.id))})]})}),e.jsx("td",{className:"py-3 px-4 text-sm text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(Te,{checked:a.active??!0,onCheckedChange:()=>me(a.id,a.username,a.active??!0),disabled:a.username==="admin"||!P}),e.jsx("span",{className:"text-xs text-gray-600",children:a.active?"Activo":"Inactivo"})]})}),e.jsx("td",{className:"py-3 px-4 text-sm text-gray-600",children:new Date(a.created_at).toLocaleDateString()}),e.jsx("td",{className:"py-3 px-4 text-sm text-right",children:a.username==="admin"?e.jsx("div",{className:"flex justify-end gap-1 flex-wrap",children:e.jsx("span",{className:"text-xs text-gray-500 italic px-2 py-1",children:"Cuenta protegida"})}):e.jsxs("div",{className:"flex justify-end gap-1 flex-wrap",children:[e.jsx(m,{variant:"ghost",size:"icon",onClick:()=>te(a),title:"Establecer contraseña temporal",children:e.jsx(we,{className:"h-4 w-4 text-blue-600"})}),e.jsx(m,{variant:"ghost",size:"icon",onClick:()=>ee(a),title:"Editar usuario",children:e.jsx(Oe,{className:"h-4 w-4"})}),e.jsx(m,{variant:"ghost",size:"icon",onClick:()=>se(a.id,a.username),title:"Eliminar usuario",children:e.jsx(Ae,{className:"h-4 w-4 text-red-600"})})]})})]},a.id)})})]}),I.length===0&&e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No se encontraron usuarios"})]})]})]}),e.jsx(D,{open:G,onOpenChange:y,children:e.jsxs(F,{children:[e.jsxs(L,{children:[e.jsx(O,{children:h?"Editar Usuario":"Crear Nuevo Usuario"}),e.jsx($,{children:h?"Actualizar información del usuario":"Agregar un nuevo usuario al sistema"})]}),e.jsxs("form",{onSubmit:ae,children:[e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"username",children:"Nombre de usuario"}),e.jsx(j,{id:"username",required:!0,value:l.username,onChange:a=>f({...l,username:a.target.value}),disabled:h&&(s==null?void 0:s.username)==="admin",className:h&&(s==null?void 0:s.username)==="admin"?"bg-gray-100 cursor-not-allowed":""}),h&&(s==null?void 0:s.username)==="admin"&&e.jsx("p",{className:"text-xs text-gray-500",children:"El nombre de usuario admin no se puede cambiar por razones de seguridad"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"email",children:"Correo electrónico"}),e.jsx(j,{id:"email",type:"email",required:!0,value:l.email,onChange:a=>f({...l,email:a.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"nombre",children:"Nombre"}),e.jsx(j,{id:"nombre",value:l.nombre,onChange:a=>f({...l,nombre:a.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"apellido",children:"Apellido"}),e.jsx(j,{id:"apellido",value:l.apellido,onChange:a=>f({...l,apellido:a.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(v,{htmlFor:"password",children:["Contraseña ",h&&"(dejar en blanco para mantener la actual)"]}),e.jsx(j,{id:"password",type:"password",required:!h,value:l.password,onChange:a=>f({...l,password:a.target.value})}),l.password&&e.jsx(Re,{password:l.password,onValidationChange:W})]})]}),e.jsxs(A,{children:[e.jsx(m,{type:"button",variant:"outline",onClick:()=>y(!1),children:"Cancelar"}),e.jsx(m,{type:"submit",children:h?"Actualizar":"Crear"})]})]})]})}),e.jsx(D,{open:Q,onOpenChange:b,children:e.jsxs(F,{children:[e.jsxs(L,{children:[e.jsx(O,{children:"Establecer Contraseña Temporal"}),e.jsxs($,{children:["Establecer una contraseña temporal para ",s==null?void 0:s.username,". El usuario deberá cambiarla en su próximo inicio de sesión."]})]}),e.jsx("div",{className:"space-y-4 py-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"temp-password",children:"Contraseña Temporal"}),e.jsx(j,{id:"temp-password",type:"text",placeholder:"Ingresa una contraseña temporal",value:k,onChange:a=>S(a.target.value),autoComplete:"off"}),e.jsx("p",{className:"text-xs text-gray-500",children:"Esta contraseña será visible para el administrador. Compártela de forma segura con el usuario."})]})}),e.jsxs(A,{children:[e.jsx(m,{type:"button",variant:"outline",onClick:()=>b(!1),children:"Cancelar"}),e.jsx(m,{type:"button",onClick:re,disabled:!k,children:"Establecer Contraseña"})]})]})}),e.jsx(D,{open:Y,onOpenChange:N,children:e.jsxs(F,{children:[e.jsxs(L,{children:[e.jsx(O,{children:"Cambiar Email"}),e.jsxs($,{children:["Cambiar el email de ",s==null?void 0:s.username,". Se enviará un email de verificación a la nueva dirección."]})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"current-email",children:"Email Actual"}),e.jsx(j,{id:"current-email",type:"email",value:(s==null?void 0:s.email)||"",disabled:!0,className:"bg-gray-100"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(v,{htmlFor:"new-email",children:"Nuevo Email"}),e.jsx(j,{id:"new-email",type:"email",placeholder:"nuevo@email.com",value:w,onChange:a=>T(a.target.value)}),e.jsx("p",{className:"text-xs text-gray-500",children:"El email será marcado como no verificado y se enviará un email de verificación."})]})]}),e.jsxs(A,{children:[e.jsx(m,{type:"button",variant:"outline",onClick:()=>N(!1),children:"Cancelar"}),e.jsx(m,{type:"button",onClick:le,disabled:!w||w===(s==null?void 0:s.email),children:"Cambiar Email"})]})]})})]})})}export{Ge as default};
//# sourceMappingURL=UsersPage-B6PmQ_S6.js.map
